apiVersion: apps/v1
kind: Deployment
metadata:
  name: load-test-simple-dashboard
  namespace: z-grid
  labels:
    app: load-test-simple-dashboard
spec:
  replicas: 1
  selector:
    matchLabels:
      app: load-test-simple-dashboard
  template:
    metadata:
      labels:
        app: load-test-simple-dashboard
    spec:
      containers:
      - name: simple-dashboard
        image: python:3.11-slim
        ports:
        - containerPort: 8080
        command: ["/bin/bash"]
        args:
          - -c
          - |
            pip install flask kubernetes aiohttp

            cat > simple_dashboard.py << 'EOF'
            from flask import Flask, jsonify, render_template_string
            import subprocess
            import time
            from kubernetes import client, config
            import threading

            app = Flask(__name__)

            # Load kubernetes config
            try:
                config.load_incluster_config()
            except:
                config.load_kube_config()

            v1 = client.CoreV1Api()
            namespace = "z-grid"
            job_name = "gateway-v2-load-test-48hr-fixed"

            def get_load_test_status():
                """Get current load test status"""
                try:
                    # Get load test pod
                    pods = v1.list_namespaced_pod(namespace, label_selector=f"job-name={job_name}")
                    if not pods.items:
                        return {"status": "not_found", "message": "Load test pod not found"}

                    pod = pods.items[0]
                    pod_name = pod.metadata.name
                    pod_status = pod.status.phase

                    # Get recent logs
                    try:
                        logs = v1.read_namespaced_pod_log(name=pod_name, namespace=namespace, tail_lines=50)
                    except:
                        logs = "Logs not available"

                    # Get resource usage
                    try:
                        metrics_cmd = ["kubectl", "top", "pod", pod_name, "-n", namespace]
                        metrics_output = subprocess.check_output(metrics_cmd, stderr=subprocess.DEVNULL).decode().strip()
                    except:
                        metrics_output = "Not available"

                    # Get Gateway V2 status
                    try:
                        gateway_pods = v1.list_namespaced_pod(namespace, label_selector="app=gateway-v2")
                        gateway_status = []
                        for gpod in gateway_pods.items:
                            ready = all(c.ready for c in gpod.status.container_statuses or [])
                            gateway_status.append({
                                "name": gpod.metadata.name,
                                "ready": ready,
                                "status": gpod.status.phase
                            })
                    except:
                        gateway_status = []

                    # Get internal services status
                    services = [
                        {"name": "DeBERTa Bias Detection", "label": "app=bias-deberta-v3"},
                        {"name": "Toxicity Detection", "label": "app=tox-service-ml-enabled"},
                        {"name": "PII Detection", "label": "app=pii-enhanced-v3"},
                        {"name": "Secrets Detection", "label": "app=secrets-service-yavar-fixed"},
                        {"name": "Jailbreak Detection", "label": "app=jailbreak-service-yavar-fixed"},
                        {"name": "Format Validation", "label": "app=format-service-yavar-fixed"},
                        {"name": "Gibberish Detection", "label": "app=gibberish-service-yavar-fixed"}
                    ]

                    service_status = []
                    for service in services:
                        try:
                            service_pods = v1.list_namespaced_pod(namespace, label_selector=service["label"])
                            running = sum(1 for p in service_pods.items if p.status.phase == "Running")
                            ready = sum(1 for p in service_pods.items if all(c.ready for c in p.status.container_statuses or []))
                            service_status.append({
                                "name": service["name"],
                                "running": running,
                                "ready": ready,
                                "total": len(service_pods.items)
                            })
                        except:
                            service_status.append({"name": service["name"], "running": 0, "ready": 0, "total": 0})

                    return {
                        "status": "running" if pod_status == "Running" else pod_status,
                        "pod_name": pod_name,
                        "pod_status": pod_status,
                        "resource_usage": metrics_output,
                        "logs": logs[-500:],  # Last 500 chars of logs
                        "gateway_pods": gateway_status,
                        "services": service_status,
                        "timestamp": time.time()
                    }

                except Exception as e:
                    return {"status": "error", "message": str(e)}

            @app.route('/')
            def dashboard():
                """Simple load test dashboard"""
                html = '''
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Gateway V2 Load Test Monitor</title>
                    <style>
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            margin: 0;
                            padding: 20px;
                            background-color: #f5f5f5;
                        }
                        .container {
                            max-width: 1200px;
                            margin: 0 auto;
                            background: white;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                            padding: 30px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            color: #2c3e50;
                        }
                        .status-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 20px;
                            margin-bottom: 30px;
                        }
                        .status-card {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            border-radius: 8px;
                            text-align: center;
                        }
                        .service-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                            margin-bottom: 30px;
                        }
                        .service-card {
                            background: #ecf0f1;
                            padding: 15px;
                            border-radius: 6px;
                            text-align: center;
                        }
                        .service-healthy { background: #d5f4e6; color: #27ae60; }
                        .service-unhealthy { background: #fadbd8; color: #e74c3c; }
                        .logs-section {
                            background: #f8f9fa;
                            border: 1px solid #dee2e6;
                            border-radius: 6px;
                            padding: 20px;
                            margin-top: 30px;
                        }
                        .logs-content {
                            font-family: 'Courier New', monospace;
                            font-size: 12px;
                            white-space: pre-wrap;
                            max-height: 300px;
                            overflow-y: auto;
                            background: #ffffff;
                            padding: 15px;
                            border-radius: 4px;
                        }
                        .refresh-info {
                            text-align: center;
                            margin-top: 20px;
                            color: #7f8c8d;
                        }
                        .pod-healthy { color: #27ae60; }
                        .pod-unhealthy { color: #e74c3c; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1 class="header">üöÄ Gateway V2 Load Test Monitor</h1>
                        <h2 style="text-align: center; color: #7f8c8d;">48-Hour Load Test - 1,000 requests/hour targeting all 7 internal services</h2>

                        <div class="status-grid" id="status-grid">
                            <div class="status-card">
                                <h3>Load Test Status</h3>
                                <div id="load-test-status">Loading...</div>
                            </div>
                            <div class="status-card">
                                <h3>Gateway V2 Pods</h3>
                                <div id="gateway-status">Loading...</div>
                            </div>
                            <div class="status-card">
                                <h3>Resource Usage</h3>
                                <div id="resource-usage">Loading...</div>
                            </div>
                            <div class="status-card">
                                <h3>Last Update</h3>
                                <div id="last-update">Loading...</div>
                            </div>
                        </div>

                        <h3>üéØ Internal Services Status</h3>
                        <div class="service-grid" id="services-grid">
                            Loading services...
                        </div>

                        <div class="logs-section">
                            <h3>üìú Recent Load Test Logs</h3>
                            <div class="logs-content" id="logs-content">Loading logs...</div>
                        </div>

                        <div class="refresh-info">
                            <p>üìä Auto-refresh every 30 seconds | üîÑ Manual refresh: F5</p>
                        </div>
                    </div>

                    <script>
                        function loadStatus() {
                            fetch('/api/status')
                                .then(response => response.json())
                                .then(data => {
                                    // Update load test status
                                    const loadTestStatus = document.getElementById('load-test-status');
                                    if (data.status === 'running') {
                                        loadTestStatus.innerHTML = `<span class="pod-healthy">‚úÖ Running</span><br><small>${data.pod_name}</small>`;
                                    } else {
                                        loadTestStatus.innerHTML = `<span class="pod-unhealthy">‚ùå ${data.status}</span>`;
                                    }

                                    // Update gateway status
                                    const gatewayStatus = document.getElementById('gateway-status');
                                    let gatewayHtml = '';
                                    data.gateway_pods.forEach(pod => {
                                        const status = pod.ready ? '<span class="pod-healthy">‚úÖ Ready</span>' : '<span class="pod-unhealthy">‚ùå Not Ready</span>';
                                        gatewayHtml += `${pod.name}: ${status}<br>`;
                                    });
                                    gatewayStatus.innerHTML = gatewayHtml || 'No gateway pods found';

                                    // Update resource usage
                                    document.getElementById('resource-usage').textContent = data.resource_usage || 'Not available';
                                    document.getElementById('last-update').textContent = new Date().toLocaleString();

                                    // Update services
                                    const servicesGrid = document.getElementById('services-grid');
                                    servicesGrid.innerHTML = '';
                                    data.services.forEach(service => {
                                        const serviceCard = document.createElement('div');
                                        const isHealthy = service.running > 0 && service.ready > 0;
                                        serviceCard.className = `service-card ${isHealthy ? 'service-healthy' : 'service-unhealthy'}`;
                                        serviceCard.innerHTML = `
                                            <strong>${service.name}</strong><br>
                                            <small>${service.ready}/${service.total} pods ready</small>
                                        `;
                                        servicesGrid.appendChild(serviceCard);
                                    });

                                    // Update logs (last 1000 chars)
                                    const logsContent = document.getElementById('logs-content');
                                    if (data.logs) {
                                        logsContent.textContent = data.logs.slice(-1000);
                                    } else {
                                        logsContent.textContent = 'No logs available';
                                    }
                                })
                                .catch(error => {
                                    console.error('Error loading status:', error);
                                    document.getElementById('load-test-status').innerHTML = '<span class="pod-unhealthy">‚ùå Error</span>';
                                });
                        }

                        // Load immediately and then every 30 seconds
                        loadStatus();
                        setInterval(loadStatus, 30000);
                    </script>
                </body>
                </html>
                '''
                return html

            @app.route('/api/status')
            def api_status():
                """API endpoint for load test status"""
                return jsonify(get_load_test_status())

            if __name__ == '__main__':
                app.run(host='0.0.0.0', port=8080, debug=False)
            EOF

            python simple_dashboard.py

        resources:
          requests:
            cpu: 25m
            memory: 64Mi
          limits:
            cpu: 50m
            memory: 128Mi
---
apiVersion: v1
kind: Service
metadata:
  name: load-test-simple-dashboard-service
  namespace: z-grid
  labels:
    app: load-test-simple-dashboard
spec:
  type: LoadBalancer
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
  selector:
    app: load-test-simple-dashboard