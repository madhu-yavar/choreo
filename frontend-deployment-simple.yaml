apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-nginx-config
  namespace: zgrid
data:
  default.conf: |
    server {
        listen 8080;
        server_name localhost;

        location / {
            root   /usr/share/nginx/html;
            index  index.html index.htm;
            try_files $uri $uri/ /index.html;
        }

        location /api {
            proxy_pass http://zgrid-chatbot-service:8010;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-app-files
  namespace: zgrid
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Z-Grid Chatbot</title>
      <style>
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
          margin: 0;
          padding: 20px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
        }
        .container {
          max-width: 800px;
          margin: 0 auto;
          background: white;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          overflow: hidden;
        }
        .header {
          background: #4a5568;
          color: white;
          padding: 20px;
          text-align: center;
        }
        .chat-container {
          height: 500px;
          overflow-y: auto;
          padding: 20px;
          background: #f7fafc;
        }
        .message {
          margin-bottom: 15px;
          padding: 12px 16px;
          border-radius: 18px;
          max-width: 70%;
          word-wrap: break-word;
        }
        .user-message {
          background: #3182ce;
          color: white;
          margin-left: auto;
          text-align: right;
        }
        .bot-message {
          background: #e2e8f0;
          color: #2d3748;
        }
        .input-container {
          padding: 20px;
          background: white;
          border-top: 1px solid #e2e8f0;
          display: flex;
          gap: 10px;
        }
        input {
          flex: 1;
          padding: 12px 16px;
          border: 1px solid #cbd5e0;
          border-radius: 25px;
          outline: none;
          font-size: 14px;
        }
        button {
          padding: 12px 24px;
          background: #3182ce;
          color: white;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-weight: 500;
        }
        button:hover {
          background: #2c5aa0;
        }
        .status-indicator {
          display: inline-block;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 500;
          margin-left: 8px;
        }
        .status-pass { background: #c6f6d5; color: #22543d; }
        .status-flagged { background: #fed7aa; color: #7c2d12; }
        .status-blocked { background: #fed7d7; color: #742a2a; }
        .status-error { background: #e2e8f0; color: #2d3748; }
        .service-details {
          margin-top: 8px;
          font-size: 11px;
          opacity: 0.8;
        }
        .hover-trigger {
          cursor: pointer;
          text-decoration: underline;
        }
        .tooltip {
          position: relative;
          display: inline-block;
        }
        .tooltip-content {
          display: none;
          position: absolute;
          bottom: 125%;
          left: 50%;
          transform: translateX(-50%);
          background: #2d3748;
          color: white;
          padding: 8px 12px;
          border-radius: 6px;
          white-space: nowrap;
          z-index: 1000;
          max-width: 300px;
          white-space: normal;
        }
        .tooltip:hover .tooltip-content {
          display: block;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>ü§ñ Z-Grid Content Moderation Chatbot</h1>
          <p>Powered by AI Gateway 2 with Real-time Content Analysis</p>
        </div>

        <div id="chatContainer" class="chat-container">
          <div class="message bot-message">
            Welcome to Z-Grid Chatbot! I demonstrate real-time content moderation using Gateway 2. Try sending different types of messages to see how our AI services detect and handle various content categories.
          </div>
        </div>

        <div class="input-container">
          <input type="text" id="messageInput" placeholder="Type your message here..."
                 onkeypress="if(event.key === 'Enter') sendMessage()">
          <button onclick="sendMessage()">Send</button>
        </div>
      </div>

      <script>
        let messageHistory = [];

        function addMessage(content, isUser = false, moderationData = null) {
          const chatContainer = document.getElementById('chatContainer');
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

          if (isUser) {
            messageDiv.textContent = content;
          } else {
            messageDiv.innerHTML = content;

            if (moderationData) {
              const statusClass = `status-${moderationData.moderation_status}`;
              const statusText = moderationData.moderation_status.toUpperCase();
              messageDiv.innerHTML += `<span class="status-indicator ${statusClass}">${statusText}</span>`;

              if (moderationData.service_details && moderationData.service_details.length > 0) {
                const servicesHtml = moderationData.service_details
                  .filter(s => s.triggered)
                  .map(s => `<div class="service-details"><strong>${s.service}:</strong> ${s.description}</div>`)
                  .join('');

                if (servicesHtml) {
                  messageDiv.innerHTML += `<div class="tooltip hover-trigger">‚ÑπÔ∏è Service Details<div class="tooltip-content">${servicesHtml}</div></div>`;
                }
              }
            }
          }

          chatContainer.appendChild(messageDiv);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendMessage() {
          const input = document.getElementById('messageInput');
          const message = input.value.trim();

          if (!message) return;

          addMessage(message, true);
          input.value = '';

          try {
            const response = await fetch('/api/chat', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                message: message,
                user_name: 'user'
              })
            });

            const data = await response.json();
            addMessage(data.response, false, {
              moderation_status: data.moderation_status,
              service_details: data.service_details
            });
          } catch (error) {
            console.error('Error:', error);
            addMessage('Sorry, I encountered an error. Please try again.', false);
          }
        }

        // Add some example messages for testing
        window.addEventListener('load', () => {
          setTimeout(() => {
            addMessage('üí° Try these examples:<br>‚Ä¢ "Hello, how are you?"<br>‚Ä¢ "My email is john@example.com"<br>‚Ä¢ "I hate everyone!"<br>‚Ä¢ "John Doe, SSN 123-45-6789"', false);
          }, 1000);
        });
      </script>
    </body>
    </html>

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zgrid-frontend
  namespace: zgrid
  labels:
    app: zgrid-frontend
    component: frontend
    version: v1.0
spec:
  replicas: 1
  selector:
    matchLabels:
      app: zgrid-frontend
  template:
    metadata:
      labels:
        app: zgrid-frontend
        component: frontend
        version: v1.0
    spec:
      containers:
      - name: frontend
        image: nginx:alpine
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        livenessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf
        - name: frontend-files
          mountPath: /usr/share/nginx/html/index.html
          subPath: index.html
      volumes:
      - name: nginx-config
        configMap:
          name: frontend-nginx-config
      - name: frontend-files
        configMap:
          name: frontend-app-files
      restartPolicy: Always
      terminationGracePeriodSeconds: 30

---
apiVersion: v1
kind: Service
metadata:
  name: zgrid-frontend-external
  namespace: zgrid
  labels:
    app: zgrid-frontend
    component: frontend
  annotations:
    service.beta.kubernetes.io/azure-load-balancer-internal: "false"
spec:
  selector:
    app: zgrid-frontend
  ports:
  - name: http
    port: 8080
    targetPort: 8080
    protocol: TCP
  type: LoadBalancer