---
# Complete Z-Grid Ingress Fix for Direct Kubernetes Deployments
# This file fixes connectivity for all your existing services
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: complete-zgrid-ingress
  namespace: z-grid
  annotations:
    # Ingress Controller Configuration
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod

    # SSL and Security
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # CORS Configuration
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-api-key,X-API-Key"

    # Proxy Settings
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"

    # Performance
    nginx.ingress.kubernetes.io/proxy-buffering: "on"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "8"

    # Custom Headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-XSS-Protection: 1; mode=block";

spec:
  # TLS Configuration for all domains
  tls:
  - hosts:
    - "*.20.242.183.197.nip.io"
    - "zgrid-gateway.20.242.183.197.nip.io"
    - "zgrid-api.20.242.183.197.nip.io"
    - "api.20.242.183.197.nip.io"
    secretName: zgrid-wildcard-tls

  rules:
  # ===== MAIN GATEWAY SERVICE =====
  # Primary entry point with intelligent routing
  - host: "zgrid-gateway.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: working-gateway-service
            port:
              number: 8008

  - host: "zgrid-api.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: working-gateway-service
            port:
              number: 8008

  # ===== INDIVIDUAL SERVICE SUBDOMAINS =====
  # PII Service
  - host: "pii.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: pii-service-yavar
            port:
              number: 8000

  # Toxicity Service
  - host: "tox.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: tox-service-yavar
            port:
              number: 8001

  # Jailbreak Service
  - host: "jail.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: jail-service-yavar
            port:
              number: 8002

  # Policy Service
  - host: "policy.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: policy-service-external
            port:
              number: 8003

  # Ban Service
  - host: "ban.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: ban-service-yavar
            port:
              number: 8004

  # Secrets Service
  - host: "secrets.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: secrets-service-yavar
            port:
              number: 8005

  # Format Service
  - host: "format.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: format-service-yavar
            port:
              number: 8006

  # Gibberish Service
  - host: "gibberish.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: gibberish-service-yavar
            port:
              number: 8007

  # Config Service
  - host: "config.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: config-service-yavar
            port:
              number: 8009

  # Bias Service
  - host: "bias.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: bias-service-yavar
            port:
              number: 8012

  # Simple Bias Service
  - host: "simple-bias.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: simple-bias-service
            port:
              number: 8013

  # ===== UNIFIED API GATEWAY (PATH-BASED ROUTING) =====
  # Access all services via single host with different paths
  - host: "api.20.242.183.197.nip.io"
    http:
      paths:
      # Gateway endpoints
      - path: /gateway(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: working-gateway-service
            port:
              number: 8008

      # PII endpoints
      - path: /pii(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: pii-service-yavar
            port:
              number: 8000

      # Toxicity endpoints
      - path: /tox(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: tox-service-yavar
            port:
              number: 8001

      # Jailbreak endpoints
      - path: /jail(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: jail-service-yavar
            port:
              number: 8002

      # Policy endpoints
      - path: /policy(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: policy-service-external
            port:
              number: 8003

      # Ban endpoints
      - path: /ban(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: ban-service-yavar
            port:
              number: 8004

      # Secrets endpoints
      - path: /secrets(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: secrets-service-yavar
            port:
              number: 8005

      # Format endpoints
      - path: /format(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: format-service-yavar
            port:
              number: 8006

      # Gibberish endpoints
      - path: /gibberish(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: gibberish-service-yavar
            port:
              number: 8007

      # Config endpoints
      - path: /config(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: config-service-yavar
            port:
              number: 8009

      # Bias endpoints
      - path: /bias(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: bias-service-yavar
            port:
              number: 8012

      # Simple Bias endpoints
      - path: /simple-bias(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: simple-bias-service
            port:
              number: 8013