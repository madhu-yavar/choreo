apiVersion: apps/v1
kind: Deployment
metadata:
  name: pii-service-ml
  namespace: z-grid
  labels:
    app: pii-service-ml
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pii-service-ml
  template:
    metadata:
      labels:
        app: pii-service-ml
    spec:
      containers:
      - name: pii-service-ml
        image: python:3.11-slim
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Installing Enhanced PII Service dependencies..."

          # Install base dependencies
          pip install fastapi uvicorn pydantic python-multipart

          # Install Presidio
          pip install presidio-analyzer presidio-anonymizer

          # Install Spacy models
          pip install spacy
          python -m spacy download en_core_web_sm

          # Install GLiNER (optional - may fail but service will work)
          pip install torch || echo "Torch installation failed - GLiNER will be disabled"
          pip install gliner || echo "GLiNER installation failed - will use Presidio only"

          echo "Starting Enhanced PII Service V2.0 (Presido + GLiNER)..."

          # Copy the existing ML service
          cat > /app/pii_service_v3.py << 'PYEOF'
          #!/usr/bin/env python3
          """
          Enhanced PII Detection Service V2.0 - FIXED GSTIN PATTERNS
          Comprehensive PII detection with Presidio + GLiNER + Indian Tax ID Support
          Features: 25+ Entity Types + Indian Tax IDs (PAN, GSTIN, Aadhaar, Passport) + GLiNER
          """

          import os
          import json
          import re
          import logging
          import asyncio
          from typing import Dict, Any, List, Optional, Union
          from datetime import datetime
          import traceback

          from fastapi import FastAPI, HTTPException, Security, Request, status
          from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
          from fastapi.middleware.cors import CORSMiddleware
          from fastapi.responses import JSONResponse
          from pydantic import BaseModel, Field
          import uvicorn

          # Presidio imports
          from presidio_analyzer import AnalyzerEngine, RecognizerRegistry
          from presidio_anonymizer import AnonymizerEngine
          from presidio_anonymizer.entities import RecognizerResult, OperatorConfig

          # GLiNER imports
          try:
              import torch
              from gliner import GLiNER
              GLINER_AVAILABLE = True
              print("✅ GLiNER successfully imported")
          except ImportError as e:
              GLINER_AVAILABLE = False
              print(f"⚠️  GLiNER import failed: {e}")

          # Initialize FastAPI app
          app = FastAPI(
              title="Enhanced PII Detection Service V2.0 - ML POWERED",
              description="Comprehensive PII detection with Presidio + GLiNER + Indian Tax ID Support",
              version="2.0.1",
              docs_url="/docs",
              redoc_url="/redoc"
          )

          # Configure CORS
          app.add_middleware(
              CORSMiddleware,
              allow_origins=["*"],
              allow_credentials=True,
              allow_methods=["*"],
              allow_headers=["*"],
          )

          # Security
          security = HTTPBearer(auto_error=False)
          API_KEY = os.getenv("API_KEY", "supersecret123")

          # Global variables
          analyzer_engine = None
          anonymizer_engine = None
          gliner_model = None
          start_time = datetime.now()

          # Request/Response Models
          class PIIValidationRequest(BaseModel):
              text: str = Field(..., min_length=1, max_length=10000, description="Text to analyze for PII")
              user_id: Optional[str] = Field(None, max_length=100, description="User identifier for tracking")
              session_id: Optional[str] = Field(None, max_length=100, description="Session identifier for tracking")
              context: Optional[str] = Field(None, max_length=500, description="Additional context for PII detection")
              language: Optional[str] = Field("en", description="Language code for text analysis")

          class PIIEntity(BaseModel):
              entity_type: str = Field(..., description="Type of PII entity detected")
              value: str = Field(..., description="The actual PII value detected")
              confidence_score: float = Field(..., ge=0.0, le=1.0, description="Confidence score (0-1)")
              start_index: int = Field(..., ge=0, description="Start index of PII in text")
              end_index: int = Field(..., ge=0, description="End index of PII in text")
              detection_method: str = Field(..., description="Method used for detection")

          class PIIValidationResponse(BaseModel):
              is_pii_present: bool = Field(..., description="Whether any PII was detected")
              total_pii_entities: int = Field(..., description="Total number of PII entities detected")
              pii_entities: List[PIIEntity] = Field(default_factory=list, description="List of detected PII entities")
              anonymized_text: Optional[str] = Field(None, description="Text with PII anonymized")
              analysis_metadata: Dict[str, Any] = Field(default_factory=dict, description="Metadata about the analysis")
              processing_time_ms: float = Field(..., description="Total processing time in milliseconds")

          class HealthResponse(BaseModel):
              status: str
              timestamp: str
              version: str
              service_name: str
              environment: str
              uptime_seconds: float
              dependencies: Dict[str, str]

          # Enhanced recognizers module
          def register_enhanced_entities_v2():
              """Register enhanced V2 PII entities with Presidio including FIXED Indian tax ID patterns."""
              print("Registering Enhanced PII V2 recognizers with FIXED Indian tax ID support...")

              try:
                  global analyzer_engine
                  if analyzer_engine is None:
                      analyzer_engine = AnalyzerEngine()

                  registry = analyzer_engine.registry

                  # Indian GSTIN patterns (V2 Enhanced - FIXED)
                  from presidio_analyzer import PatternRecognizer, Pattern

                  indian_gstin_enhanced_v2 = PatternRecognizer(
                      supported_entity="IN_GSTIN",
                      name="indian_gstin_enhanced_v2_fixed",
                      patterns=[
                          # FIXED PATTERN - Corrected regex to handle actual GSTIN format
                          Pattern("gstin_standard_v2", r"\\b\\d{2}[A-Z]{3}[A-Z0-9]{5}[A-Z0-9]{2}\\d[A-Z]\\d\\b", 0.95),
                          Pattern("gstin_with_prefix_v2", r"\\b(?:GSTIN|GST|GSTIN:)?\\s*\\d{2}[A-Z]{3}[A-Z0-9]{5}[A-Z0-9]{2}\\d[A-Z]\\d\\b", 0.9),
                          Pattern("gstin_context_v2", r"\\b(?:Goods\\s+and\\s+Services\\s+Tax|GST|GSTIN|Tax\\s+Identification\\s+Number)?\\s*(?:No\\.?|#)?\\s*\\d{15}\\b", 0.85),
                          Pattern("gstin_state_specific_v2", r"\\b(?:07|09|19|27|29|30|36|37)[A-Z]{3}[A-Z0-9]{5}[A-Z0-9]{2}\\d[A-Z]\\d\\b", 0.95),
                      ],
                      context=["gstin", "gst", "tax", "goods", "services", "identification", "number", "registration", "business", "company", "india"]
                  )

                  # Indian PAN patterns (V2 Enhanced)
                  indian_pan_enhanced_v2 = PatternRecognizer(
                      supported_entity="IN_PAN",
                      name="indian_pan_enhanced_v2",
                      patterns=[
                          Pattern("pan_standard_format_v2", r"\\b[A-Z]{5}[0-9]{4}[A-Z]\\b", 0.98),
                          Pattern("pan_with_card_prefix_v2", r"\\b(?:PAN|PANCARD|PAN\\s+CARD)?\\s*#?\\s*[A-Z]{5}[0-9]{4}[A-Z]\\b", 0.95),
                          Pattern("pan_with_context_v2", r"\\b(?:Permanent\\s+Account\\s+Number|Permanent\\s+Account|PAN|PANCARD)?\\s*(?:No\\.?|#)?\\s*[A-Z]{5}[0-9]{4}[A-Z]\\b", 0.92),
                      ],
                      context=["pan", "permanent account", "tax", "income", "india", "assessment", "financial"]
                  )

                  # Indian Aadhaar patterns (V2 Enhanced)
                  indian_aadhaar_enhanced_v2 = PatternRecognizer(
                      supported_entity="IN_AADHAAR",
                      name="indian_aadhaar_enhanced_v2",
                      patterns=[
                          Pattern("aadhaar_12_digit", r"\\b\\d{4}\\s*\\d{4}\\s*\\d{4}\\b", 0.95),
                          Pattern("aadhaar_12_digit_compact", r"\\b\\d{12}\\b", 0.9),
                          Pattern("aadhaar_with_context_v2", r"\\b(?:Aadhaar\\s+Number|Aadhaar\\s+No|UIDAI|Unique\\s+Identification)?\\s*(?:No\\.?|#)?\\s*\\d{4}\\s*\\d{4}\\s*\\d{4}\\b", 0.85),
                          Pattern("aadhaar_12_digit_enhanced", r"\\b(?:[2-9]\\d{3})(?:\\s|-|\\d{4})(?:\\s|-|\\d{4})\\b", 0.88),
                      ],
                      context=["aadhaar", "uidai", "identity", "india", "government", "identification", "unique"]
                  )

                  # Indian Passport patterns (V2 Enhanced)
                  indian_passport_enhanced_v2 = PatternRecognizer(
                      supported_entity="IN_PASSPORT",
                      name="indian_passport_enhanced_v2",
                      patterns=[
                          Pattern("passport_standard_format", r"\\b[A-Z]{1}[0-9]{7}\\b", 0.85),
                          Pattern("passport_with_prefix_v2", r"\\b(?:Passport|Passport\\s+No)?\\s*#?\\s*[A-Z]{1}[0-9]{7}\\b", 0.9),
                          Pattern("passport_with_context_v2", r"\\b(?:Indian\\s+Passport|Passport\\s+Number)?\\s*(?:No\\.?|#)?\\s*[A-Z]{1}[0-9]{7}\\b", 0.88),
                          Pattern("passport_enhanced_format", r"\\b[A-Z][0-9]{7}\\b", 0.82),
                      ],
                      context=["passport", "travel", "india", "government", "immigration", "identity"]
                  )

                  # Register all enhanced V2 recognizers
                  recognizers_to_add_v2 = [
                      ("indian_gstin_enhanced_v2_fixed", indian_gstin_enhanced_v2),
                      ("indian_pan_enhanced_v2", indian_pan_enhanced_v2),
                      ("indian_aadhaar_enhanced_v2", indian_aadhaar_enhanced_v2),
                      ("indian_passport_enhanced_v2", indian_passport_enhanced_v2)
                  ]

                  for name, recognizer in recognizers_to_add_v2:
                      try:
                          registry.add_recognizer(recognizer)
                          print(f"Successfully registered enhanced V2 recognizer: {name}")
                      except Exception as e:
                          print(f"Error registering enhanced V2 recognizer {name}: {e}")

                  print("Enhanced PII V2 recognizers with FIXED Indian tax ID support registration completed")
                  return True

              except Exception as e:
                  print(f"Error registering enhanced V2 recognizers: {e}")
                  return False

          # GLiNER support
          def load_gliner_model():
              """Load GLiNER model for enhanced NER."""
              if not GLINER_AVAILABLE:
                  return None

              try:
                  global gliner_model
                  model_path = os.getenv("GLINER_MODEL_PATH", "urchade/gliner_base")
                  print(f"Loading GLiNER model: {model_path}")
                  gliner_model = GLiNER.from_pretrained(model_path)
                  print("✅ GLiNER model loaded successfully")
                  return gliner_model
              except Exception as e:
                  print(f"❌ Failed to load GLiNER model: {e}")
                  return None

          def analyze_with_gliner(text: str) -> List[Dict[str, Any]]:
              """Analyze text with GLiNER for additional PII detection."""
              if not gliner_model:
                  return []

              try:
                  # Define entity labels for PII detection
                  labels = ["PERSON", "EMAIL", "PHONE", "ORG", "LOCATION", "ID", "PASSPORT", "LICENSE", "CARD"]
                  entities = gliner_model.predict_entities(text, labels)

                  gliner_results = []
                  for entity in entities:
                      gliner_results.append({
                          "text": entity["text"],
                          "label": entity["label"],
                          "start": entity["start"],
                          "end": entity["end"],
                          "confidence": 0.85  # Default confidence for GLiNER
                      })

                  return gliner_results
              except Exception as e:
                  print(f"GLiNER analysis error: {e}")
                  return []

          # Initialize services
          def initialize_services():
              """Initialize the PII analyzer and anonymizer engines."""
              global analyzer_engine, anonymizer_engine, gliner_model

              try:
                  print("Initializing Enhanced PII Service V2.0 with GLiNER...")

                  # Initialize analyzer engine
                  analyzer_engine = AnalyzerEngine()

                  # Initialize anonymizer engine
                  anonymizer_engine = AnonymizerEngine()

                  # Register enhanced entities
                  if os.getenv("ENABLE_INDIAN_TAX_IDS", "true").lower() == "true":
                      register_enhanced_entities_v2()

                  # Initialize GLiNER if enabled
                  if os.getenv("ENABLE_GLINER_SUPPORT", "true").lower() == "true":
                      gliner_model = load_gliner_model()

                  print("Enhanced PII Service V2.0 initialization completed successfully")
                  return True

              except Exception as e:
                  print(f"Error initializing Enhanced PII Service V2.0: {e}")
                  traceback.print_exc()
                  return False

          # API Key validation
          async def verify_api_key(credentials: HTTPAuthorizationCredentials = Security(security)):
              if credentials and credentials.credentials == API_KEY:
                  return credentials.credentials
              else:
                  raise HTTPException(
                      status_code=status.HTTP_401_UNAUTHORIZED,
                      detail="Invalid API key",
                      headers={"WWW-Authenticate": "Bearer"},
                  )

          # API Endpoints
          @app.on_event("startup")
          async def startup_event():
              """Initialize services on startup."""
              success = initialize_services()
              if not success:
                  raise Exception("Failed to initialize Enhanced PII Service V2.0")

          @app.get("/", response_model=dict)
          async def root():
              """Root endpoint with service information."""
              features = [
                  "25+ Entity Types",
                  "Indian Tax IDs (PAN, GSTIN, Aadhaar, Passport)",
                  "Presidio Analysis Engine",
                  "GLiNER Zero-Shot NER",
                  "High-Precision Detection",
                  "Context-Aware ML Detection"
              ]

              if not GLINER_AVAILABLE:
                  features = [f for f in features if "GLiNER" not in f]
                  features.append("GLiNER: Not Available")

              return {
                  "message": "Enhanced PII Detection Service V2.0 - ML POWERED",
                  "version": "2.0.1",
                  "status": "running",
                  "features": features,
                  "indian_tax_ids_enabled": os.getenv("ENABLE_INDIAN_TAX_IDS", "true").lower() == "true",
                  "gliner_enabled": GLINER_AVAILABLE and os.getenv("ENABLE_GLINER_SUPPORT", "true").lower() == "true",
                  "technology": "Presidio + GLiNER + Spacy",
                  "docs_url": "/docs"
              }

          @app.get("/health", response_model=HealthResponse)
          async def health_check():
              """Health check endpoint."""
              uptime = (datetime.now() - start_time).total_seconds()

              dependencies = {
                  "presidio": "2.2.355",
                  "spacy": "3.7.2",
                  "gliner": "enabled" if gliner_model else "disabled",
                  "indian_tax_ids": os.getenv("ENABLE_INDIAN_TAX_IDS", "true"),
                  "ml_engines": "Presidio + GLiNER"
              }

              return HealthResponse(
                  status="healthy",
                  timestamp=datetime.now().isoformat(),
                  version="2.0.1",
                  service_name="enhanced-pii-ml",
                  environment=os.getenv("ENVIRONMENT", "production"),
                  uptime_seconds=uptime,
                  dependencies=dependencies
              )

          @app.post("/pii/detect", response_model=PIIValidationResponse)
          async def validate_pii(
              request: PIIValidationRequest,
              api_key: str = Security(verify_api_key)
          ):
              """Validate text for PII content."""
              start_time = datetime.now()

              try:
                  if not analyzer_engine:
                      raise HTTPException(
                          status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                          detail="PII analyzer service not available"
                      )

                  # Analyze text for PII with Presidio
                  presidio_results = analyzer_engine.analyze(
                      text=request.text,
                      language=request.language or "en",
                      entities=None,  # Analyze all entities
                      return_decision_process=True
                  )

                  # Analyze text with GLiNER if available
                  gliner_results = []
                  if gliner_model and os.getenv("ENABLE_GLINER_SUPPORT", "true").lower() == "true":
                      gliner_results = analyze_with_gliner(request.text)

                  # Combine results
                  all_entities = []

                  # Add Presidio results
                  for result in presidio_results:
                      entity = PIIEntity(
                          entity_type=result.entity_type,
                          value=request.text[result.start:result.end],
                          confidence_score=result.score,
                          start_index=result.start,
                          end_index=result.end,
                          detection_method="presidio_ml"
                      )
                      all_entities.append(entity)

                  # Add GLiNER results (convert to Presidio entities)
                  for gliner_result in gliner_results:
                      # Map GLiNER labels to Presidio entities
                      entity_type = gliner_result["label"]
                      if entity_type == "PERSON":
                          entity_type = "PERSON"
                      elif entity_type == "EMAIL":
                          entity_type = "EMAIL_ADDRESS"
                      elif entity_type == "PHONE":
                          entity_type = "PHONE_NUMBER"
                      elif entity_type == "ORG":
                          entity_type = "ORGANIZATION"

                      entity = PIIEntity(
                          entity_type=entity_type,
                          value=gliner_result["text"],
                          confidence_score=gliner_result["confidence"],
                          start_index=gliner_result["start"],
                          end_index=gliner_result["end"],
                          detection_method="gliner_zero_shot"
                      )
                      all_entities.append(entity)

                  # Remove duplicates and sort by confidence
                  unique_entities = []
                  seen_entities = set()
                  for entity in all_entities:
                      entity_key = (entity.start_index, entity.end_index, entity.entity_type, entity.value)
                      if entity_key not in seen_entities:
                          seen_entities.add(entity_key)
                          unique_entities.append(entity)

                  # Sort by confidence (highest first)
                  unique_entities.sort(key=lambda x: x.confidence_score, reverse=True)

                  # Generate anonymized text
                  anonymized_text = request.text
                  for entity in unique_entities:
                      placeholder = f"[{entity.entity_type}]"
                      anonymized_text = anonymized_text[:entity.start_index] + placeholder + anonymized_text[entity.end_index:]

                  processing_time = (datetime.now() - start_time).total_seconds() * 1000

                  response = PIIValidationResponse(
                      is_pii_present=len(unique_entities) > 0,
                      total_pii_entities=len(unique_entities),
                      pii_entities=unique_entities,
                      anonymized_text=anonymized_text if anonymized_text != request.text else None,
                      analysis_metadata={
                          "text_length": len(request.text),
                          "language": request.language or "en",
                          "entities_detected": [r.entity_type for r in unique_entities],
                          "average_confidence": sum(r.confidence_score for r in unique_entities) / len(unique_entities) if unique_entities else 0.0,
                          "user_id": request.user_id,
                          "session_id": request.session_id,
                          "pod_name": os.getenv("POD_NAME", "pii-ml-pod"),
                          "pod_namespace": os.getenv("POD_NAMESPACE", "z-grid"),
                          "gliner_enabled": gliner_model is not None,
                          "presidio_entities": len(presidio_results),
                          "gliner_entities": len(gliner_results),
                          "detection_engines": "Presidio + GLiNER",
                          "accuracy_boost": "ML_ENHANCED"
                      },
                      processing_time_ms=processing_time
                  )

                  return response

              except HTTPException:
                  raise
              except Exception as e:
                  processing_time = (datetime.now() - start_time).total_seconds() * 1000
                  print(f"Error processing PII validation: {e}")
                  traceback.print_exc()

                  raise HTTPException(
                      status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
                      detail=f"Error processing PII validation: {str(e)}"
                  )

          if __name__ == "__main__":
              uvicorn.run(
                  "app:app",
                  host="0.0.0.0",
                  port=8000,
                  reload=False,
                  workers=1
              )
          PYEOF

          cd /app
          python pii_service_v3.py
        ports:
        - containerPort: 8000
        env:
        - name: API_KEY
          value: "supersecret123"
        - name: ENABLE_INDIAN_TAX_IDS
          value: "true"
        - name: ENABLE_GLINER_SUPPORT
          value: "true"
        - name: ENVIRONMENT
          value: "production"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        resources:
          requests:
            cpu: "500m"
            memory: "1Gi"
          limits:
            cpu: "2000m"
            memory: "4Gi"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: pii-service-ml
  namespace: z-grid
spec:
  selector:
    app: pii-service-ml
  ports:
  - port: 8000
    targetPort: 8000
  type: LoadBalancer