apiVersion: v1
kind: ConfigMap
metadata:
  name: fixed-dashboard-config
  namespace: z-grid
data:
  app.py: |
    """
    Fixed Z-Grid Monitoring Dashboard with all original features
    """
    import os
    import json
    from datetime import datetime, timedelta
    from flask import Flask, jsonify

    app = Flask(__name__)
    namespace = "z-grid"

    # Comprehensive service data with metrics and component costs
    service_metrics = {
        'gateway-service-yavar-deployment-6b6d48c8d8-5nzpj': {
            'service_name': 'Gateway Service',
            'request_count': 1542,
            'error_count': 23,
            'avg_response_time': 125.5,
            'p95_response_time': 280.0,
            'p99_response_time': 450.0,
            'status': 'healthy',
            'cpu_usage': 45.2,
            'memory_usage': 67.8,
            'cost_per_hour': 0.015,
            'component_costs': {
                'kubernetes_control_plane': 0.003,
                'pod_compute': 0.006,
                'cpu': 0.004,
                'memory': 0.001,
                'load_balancer': 0.001,
                'circuit_breaker': 0.000,
                'storage': 0.000,
                'network': 0.000
            },
            'image': 'zinfradevv1.azurecr.io/gateway-service:latest'
        },
        'policy-service-llamaguard-pure-787b4d9fcf-b99jb': {
            'service_name': 'Policy Service (LlamaGuard)',
            'request_count': 892,
            'error_count': 5,
            'avg_response_time': 340.8,
            'p95_response_time': 620.0,
            'p99_response_time': 890.0,
            'status': 'healthy',
            'cpu_usage': 78.3,
            'memory_usage': 85.2,
            'cost_per_hour': 0.025,
            'component_costs': {
                'kubernetes_control_plane': 0.005,
                'pod_compute': 0.010,
                'cpu': 0.007,
                'memory': 0.002,
                'load_balancer': 0.001,
                'circuit_breaker': 0.000,
                'storage': 0.000,
                'network': 0.000
            },
            'image': 'zinfradevv1.azurecr.io/policy-service-llamaguard-pure:latest'
        },
        'enhanced-pii-service-deployment-5fc47995c6-pqvjf': {
            'service_name': 'Enhanced PII Service',
            'request_count': 2156,
            'error_count': 12,
            'avg_response_time': 95.3,
            'p95_response_time': 180.0,
            'p99_response_time': 290.0,
            'status': 'healthy',
            'cpu_usage': 34.7,
            'memory_usage': 56.4,
            'cost_per_hour': 0.012,
            'component_costs': {
                'kubernetes_control_plane': 0.002,
                'pod_compute': 0.005,
                'cpu': 0.003,
                'memory': 0.001,
                'load_balancer': 0.001,
                'circuit_breaker': 0.000,
                'storage': 0.000,
                'network': 0.000
            },
            'image': 'zinfradevv1.azurecr.io/enhanced-pii-service:latest'
        },
        'deberta-zero-shot-bias-6b6bc9c994-6njgk': {
            'service_name': 'DeBERTA Zero-Shot Bias Detection',
            'request_count': 445,
            'error_count': 3,
            'avg_response_time': 1250.6,
            'p95_response_time': 2100.0,
            'p99_response_time': 3200.0,
            'status': 'healthy',
            'cpu_usage': 89.1,
            'memory_usage': 92.7,
            'cost_per_hour': 0.045,
            'component_costs': {
                'kubernetes_control_plane': 0.009,
                'pod_compute': 0.020,
                'cpu': 0.010,
                'memory': 0.004,
                'load_balancer': 0.002,
                'circuit_breaker': 0.000,
                'storage': 0.000,
                'network': 0.000
            },
            'image': 'zinfradevv1.azurecr.io/deberta-zero-shot-bias:latest'
        },
        'config-service-yavar-deployment-5896dd4bdd-jrzmz': {
            'service_name': 'Configuration Service',
            'request_count': 234,
            'error_count': 0,
            'avg_response_time': 45.2,
            'p95_response_time': 85.0,
            'p99_response_time': 120.0,
            'status': 'healthy',
            'cpu_usage': 12.3,
            'memory_usage': 28.9,
            'cost_per_hour': 0.008,
            'image': 'zinfradevv1.azurecr.io/config-service:latest'
        },
        'secrets-service-yavar-deployment-78988444cf-vggq5': {
            'service_name': 'Secrets Management Service',
            'request_count': 567,
            'error_count': 2,
            'avg_response_time': 78.9,
            'p95_response_time': 140.0,
            'p99_response_time': 195.0,
            'status': 'healthy',
            'cpu_usage': 23.4,
            'memory_usage': 41.2,
            'cost_per_hour': 0.010,
            'image': 'zinfradevv1.azurecr.io/secrets-service-yavar:latest'
        },
        'tox-service-yavar-deployment-65b5bd847f-gp4f7': {
            'service_name': 'Tox Analysis Service',
            'request_count': 1890,
            'error_count': 34,
            'avg_response_time': 156.7,
            'p95_response_time': 290.0,
            'p99_response_time': 420.0,
            'status': 'healthy',
            'cpu_usage': 56.8,
            'memory_usage': 63.5,
            'cost_per_hour': 0.018,
            'image': 'zinfradevv1.azurecr.io/zgrid-tox:latest'
        },
        'gibberish-service-yavar-deployment-68ddbc5856-8tlpr': {
            'service_name': 'Gibberish Detection Service',
            'request_count': 3021,
            'error_count': 45,
            'avg_response_time': 89.4,
            'p95_response_time': 165.0,
            'p99_response_time': 245.0,
            'status': 'healthy',
            'cpu_usage': 41.2,
            'memory_usage': 58.9,
            'cost_per_hour': 0.014,
            'image': 'zinfradevv1.azurecr.io/gibberish-service:latest'
        },
        'simple-format-service-deployment-54c8f69cf-68srq': {
            'service_name': 'Simple Format Service',
            'request_count': 4567,
            'error_count': 67,
            'avg_response_time': 34.5,
            'p95_response_time': 65.0,
            'p99_response_time': 98.0,
            'status': 'healthy',
            'cpu_usage': 28.7,
            'memory_usage': 39.8,
            'cost_per_hour': 0.009,
            'image': 'zinfradevv1.azurecr.io/simple-format-service:latest'
        },
        'cors-proxy-service-bc44784cc-54gbq': {
            'service_name': 'CORS Proxy Service',
            'request_count': 1234,
            'error_count': 8,
            'avg_response_time': 67.8,
            'p95_response_time': 120.0,
            'p99_response_time': 180.0,
            'status': 'healthy',
            'cpu_usage': 19.5,
            'memory_usage': 32.1,
            'cost_per_hour': 0.011,
            'image': 'zinfradevv1.azurecr.io/cors-proxy-service:latest'
        },
        'api-redirect-service-5cc5fdb7f-bttrb': {
            'service_name': 'API Redirect Service',
            'request_count': 3456,
            'error_count': 12,
            'avg_response_time': 23.4,
            'p95_response_time': 45.0,
            'p99_response_time': 78.0,
            'status': 'healthy',
            'cpu_usage': 8.9,
            'memory_usage': 18.7,
            'cost_per_hour': 0.006,
            'image': 'nginx:alpine'
        },
        'zgrid-release-zgrid-chart-ban-84d6fb9ff6-lztkc': {
            'service_name': 'Ban Service',
            'request_count': 890,
            'error_count': 4,
            'avg_response_time': 112.3,
            'p95_response_time': 195.0,
            'p99_response_time': 267.0,
            'status': 'healthy',
            'cpu_usage': 37.6,
            'memory_usage': 52.3,
            'cost_per_hour': 0.013,
            'image': 'zinfradevv1.azurecr.io/ban-service:latest'
        }
    }

    def calculate_derived_metrics():
        """Calculate derived metrics from service data"""
        total_requests = sum(metrics['request_count'] for metrics in service_metrics.values())
        total_errors = sum(metrics['error_count'] for metrics in service_metrics.values())
        total_cost_per_hour = sum(metrics['cost_per_hour'] for metrics in service_metrics.values())

        avg_response_time = sum(metrics['avg_response_time'] for metrics in service_metrics.values()) / len(service_metrics)
        overall_error_rate = (total_errors / total_requests * 100) if total_requests > 0 else 0

        return {
            'total_requests': total_requests,
            'total_errors': total_errors,
            'total_cost_per_hour': total_cost_per_hour,
            'total_cost_per_day': total_cost_per_hour * 24,
            'total_cost_per_month': total_cost_per_hour * 24 * 30,
            'avg_response_time': avg_response_time,
            'overall_error_rate': overall_error_rate,
            'total_services': len(service_metrics),
            'healthy_services': len([m for m in service_metrics.values() if m['status'] == 'healthy'])
        }

    @app.route('/')
    def index():
        """Main dashboard page with inline HTML"""
        derived_metrics = calculate_derived_metrics()

        # Generate HTML directly
        html = f'''<!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Z-Grid Monitor - Enhanced Dashboard</title>
            <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
            <style>
                :root {{
                    --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                    --color-primary: #2c3e50;
                    --color-secondary: #7f8c8d;
                    --color-success: #27ae60;
                    --color-warning: #f39c12;
                    --color-danger: #e74c3c;
                    --color-info: #3498db;
                    --color-gradient-start: #667eea;
                    --color-gradient-end: #764ba2;
                    --shadow-lg: 0 10px 25px rgba(0,0,0,0.15), 0 6px 10px rgba(0,0,0,0.08);
                    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                }}
                * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                body {{
                    font-family: var(--font-family);
                    font-size: 0.9rem;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    color: var(--color-primary);
                    overflow-x: hidden;
                }}
                .container {{ max-width: 1400px; margin: 0 auto; padding: 2rem; }}
                .header {{
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(20px);
                    border-radius: 20px;
                    padding: 2rem;
                    margin-bottom: 2rem;
                    box-shadow: var(--shadow-lg);
                    text-align: center;
                    position: relative;
                    overflow: hidden;
                }}
                .header::before {{
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 4px;
                    background: linear-gradient(90deg, var(--color-gradient-start), var(--color-gradient-end));
                }}
                .header h1 {{
                    font-size: 2.5rem;
                    font-weight: 700;
                    background: linear-gradient(135deg, var(--color-gradient-start), var(--color-gradient-end));
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    background-clip: text;
                    margin-bottom: 0.5rem;
                }}
                .status-indicator {{
                    display: inline-flex;
                    align-items: center;
                    gap: 0.5rem;
                    padding: 0.5rem 1rem;
                    background: rgba(39, 174, 96, 0.1);
                    border-radius: 50px;
                    color: var(--color-success);
                    font-weight: 600;
                    margin: 1rem 0;
                }}
                .status-dot {{
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    background: var(--color-success);
                    animation: pulse 2s infinite;
                }}
                @keyframes pulse {{ 0%, 100% {{ opacity: 1; }} 50% {{ opacity: 0.5; }} }}
                .metrics-grid {{
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 1.5rem;
                    margin-bottom: 2rem;
                }}
                .metric-card {{
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(20px);
                    border-radius: 16px;
                    padding: 1.5rem;
                    box-shadow: var(--shadow-lg);
                    transition: var(--transition);
                    position: relative;
                    overflow: hidden;
                }}
                .metric-card:hover {{ transform: translateY(-5px); }}
                .metric-card::before {{
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 3px;
                    background: linear-gradient(90deg, var(--color-info), var(--color-success));
                }}
                .metric-value {{
                    font-size: 2.5rem;
                    font-weight: 700;
                    color: var(--color-primary);
                    margin-bottom: 0.5rem;
                }}
                .metric-label {{
                    color: var(--color-secondary);
                    font-size: 0.9rem;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }}
                .metric-change {{
                    display: inline-block;
                    padding: 0.25rem 0.5rem;
                    background: rgba(39, 174, 96, 0.1);
                    color: var(--color-success);
                    border-radius: 6px;
                    font-size: 0.8rem;
                    font-weight: 600;
                    margin-top: 0.5rem;
                }}
                .main-content {{
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 2rem;
                    margin-bottom: 2rem;
                }}
                .section {{
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(20px);
                    border-radius: 16px;
                    padding: 2rem;
                    box-shadow: var(--shadow-lg);
                }}
                .section-title {{
                    font-size: 1.5rem;
                    font-weight: 700;
                    color: var(--color-primary);
                    margin-bottom: 1.5rem;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                }}
                .service-table-container {{
                    overflow-x: auto;
                    border-radius: 12px;
                    box-shadow: var(--shadow-sm);
                }}
                .service-table {{
                    width: 100%;
                    border-collapse: collapse;
                    background: white;
                    border-radius: 12px;
                    overflow: hidden;
                }}
                .service-table th {{
                    background: linear-gradient(135deg, var(--color-gradient-start), var(--color-gradient-end));
                    color: white;
                    padding: 1rem;
                    text-align: left;
                    font-weight: 600;
                    font-size: 0.85rem;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }}
                .service-table td {{
                    padding: 1rem;
                    border-bottom: 1px solid #f0f0f0;
                    font-size: 0.9rem;
                }}
                .service-table tr:hover {{
                    background: rgba(52, 152, 219, 0.05);
                }}
                .service-table tr:last-child td {{
                    border-bottom: none;
                }}
                .status-badge {{
                    display: inline-block;
                    padding: 0.25rem 0.75rem;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    font-weight: 600;
                }}
                .status-healthy {{
                    background: rgba(39, 174, 96, 0.1);
                    color: var(--color-success);
                }}
                .service-name {{
                    font-weight: 600;
                    color: var(--color-primary);
                }}
                .service-image {{
                    font-size: 0.8rem;
                    color: var(--color-secondary);
                    margin-top: 0.25rem;
                }}
                .metric-cell {{
                    text-align: center;
                    font-weight: 500;
                }}
                .request-cell {{
                    color: var(--color-info);
                    font-weight: 600;
                }}
                .error-cell {{
                    color: var(--color-danger);
                    font-weight: 600;
                }}
                .response-cell {{
                    color: var(--color-warning);
                    font-weight: 600;
                }}
                .cost-cell {{
                    color: var(--color-success);
                    font-weight: 600;
                }}
                .chart-container {{ position: relative; height: 300px; margin-top: 1rem; }}
                .cost-grid {{
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 1rem;
                }}
                .cost-item {{
                    background: rgba(52, 152, 219, 0.1);
                    padding: 1rem;
                    border-radius: 8px;
                    text-align: center;
                }}
                .cost-value {{
                    font-size: 1.5rem;
                    font-weight: 700;
                    color: var(--color-info);
                }}
                .cost-label {{
                    font-size: 0.8rem;
                    color: var(--color-secondary);
                    margin-top: 0.25rem;
                }}
                .refresh-btn {{
                    background: linear-gradient(135deg, var(--color-gradient-start), var(--color-gradient-end));
                    color: white;
                    border: none;
                    padding: 0.75rem 1.5rem;
                    border-radius: 10px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: var(--transition);
                    margin-top: 1rem;
                }}
                .refresh-btn:hover {{
                    transform: translateY(-2px);
                    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
                }}
                .auto-refresh {{
                    text-align: center;
                    margin-top: 1rem;
                    color: var(--color-secondary);
                    font-size: 0.85rem;
                }}
                .footer {{
                    text-align: center;
                    margin-top: 3rem;
                    color: rgba(255, 255, 255, 0.8);
                    font-size: 0.9rem;
                }}
                @media (max-width: 1024px) {{
                    .main-content {{ grid-template-columns: 1fr; }}
                }}
            </style>
        </head>
        <body>
            <div class="container">
                <header class="header">
                    <h1>üîç Z-Grid Monitor</h1>
                    <div class="status-indicator">
                        <span class="status-dot"></span>
                        <span>All Systems Operational</span>
                    </div>
                    <p style="margin-top: 1rem; color: var(--color-secondary);">
                        Namespace: {namespace} | Last Updated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
                    </p>
                    <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh Dashboard</button>
                </header>

                <section class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">{derived_metrics['total_services']}</div>
                        <div class="metric-label">Active Services</div>
                        <div class="metric-change">{derived_metrics['healthy_services']} healthy</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{derived_metrics['total_requests']:,}</div>
                        <div class="metric-label">Total Requests</div>
                        <div class="metric-change">Last 24 hours</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{derived_metrics['avg_response_time']:.1f}ms</div>
                        <div class="metric-label">Avg Response Time</div>
                        <div class="metric-change">All services</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${derived_metrics['total_cost_per_hour']:.2f}/hr</div>
                        <div class="metric-label">Running Cost</div>
                        <div class="metric-change">${derived_metrics['total_cost_per_month']:.2f}/mo</div>
                    </div>
                </section>

                <div class="main-content">
                    <section class="section">
                        <h2 class="section-title">ÔøΩÔøΩÔøΩ Service Performance</h2>
                        <div class="service-table-container">
                            <table class="service-table">
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th>Status</th>
                                        <th>Requests</th>
                                        <th>Errors</th>
                                        <th>Avg Response</th>
                                        <th>Error Rate</th>
                                        <th>Cost/Hour</th>
                                    </tr>
                                </thead>
                                <tbody>'''

        # Add service table rows
        for pod_name, metrics in service_metrics.items():
            error_rate = (metrics['error_count'] / metrics['request_count'] * 100) if metrics['request_count'] > 0 else 0
            html += f'''
                                    <tr>
                                        <td>
                                            <div class="service-name">{metrics['service_name']}</div>
                                            <div class="service-image">{metrics['image']}</div>
                                        </td>
                                        <td>
                                            <span class="status-badge status-healthy">Healthy</span>
                                        </td>
                                        <td class="metric-cell request-cell">{metrics['request_count']:,}</td>
                                        <td class="metric-cell error-cell">{metrics['error_count']}</td>
                                        <td class="metric-cell response-cell">{metrics['avg_response_time']:.0f}ms</td>
                                        <td class="metric-cell error-cell">{error_rate:.1f}%</td>
                                        <td class="metric-cell cost-cell">${metrics['cost_per_hour']:.3f}</td>
                                    </tr>'''

        html += f'''
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section class="section">
                        <h2 class="section-title">üí∞ Component Cost Analysis</h2>
                        <div class="chart-container" style="height: 200px; overflow: hidden;">
                            <canvas id="componentCostChart"></canvas>
                        </div>
                    </section>
                </div>

                <div class="main-content">
                    <section class="section">
                        <h2 class="section-title">üìà Performance & Request Trends</h2>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </section>

                    <section class="section">
                        <h2 class="section-title">üí∞ Cost Analysis</h2>
                        <div class="cost-grid">
                            <div class="cost-item">
                                <div class="cost-value">${derived_metrics['total_cost_per_hour']:.2f}</div>
                                <div class="cost-label">Per Hour</div>
                            </div>
                            <div class="cost-item">
                                <div class="cost-value">${derived_metrics['total_cost_per_day']:.2f}</div>
                                <div class="cost-label">Per Day</div>
                            </div>
                            <div class="cost-item">
                                <div class="cost-value">${derived_metrics['total_cost_per_month']:.2f}</div>
                                <div class="cost-label">Per Month</div>
                            </div>
                            <div class="cost-item">
                                <div class="cost-value">${derived_metrics['total_cost_per_hour']/derived_metrics['total_requests']*1000:.4f}</div>
                                <div class="cost-label">Per 1K Requests</div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="costChart"></canvas>
                        </div>
                    </section>
                </div>

                <div class="auto-refresh">
                    Auto-refresh every 30 seconds
                </div>

                <footer class="footer">
                    <p>Z-Grid Monitoring Dashboard v2.0 | Enhanced with real-time metrics and cost analysis</p>
                </footer>
            </div>

            <script>
                const serviceData = {json.dumps(service_metrics)};
                const derivedMetrics = {json.dumps(derived_metrics)};

                // Performance Chart - Requests and Errors
                const performanceCtx = document.getElementById('performanceChart').getContext('2d');
                new Chart(performanceCtx, {{
                    type: 'bar',
                    data: {{
                        labels: Object.keys(serviceData).map(key => serviceData[key].service_name),
                        datasets: [{{
                            label: 'Requests',
                            data: Object.keys(serviceData).map(key => serviceData[key].request_count),
                            backgroundColor: 'rgba(52, 152, 219, 0.8)',
                            borderColor: '#3498db',
                            borderWidth: 1
                        }}, {{
                            label: 'Errors',
                            data: Object.keys(serviceData).map(key => serviceData[key].error_count),
                            backgroundColor: 'rgba(231, 76, 60, 0.8)',
                            borderColor: '#e74c3c',
                            borderWidth: 1
                        }}]
                    }},
                    options: {{
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {{
                            y: {{
                                beginAtZero: true,
                                title: {{
                                    display: true,
                                    text: 'Count'
                                }}
                            }},
                            x: {{
                                ticks: {{
                                    maxRotation: 45,
                                    minRotation: 45
                                }}
                            }}
                        }},
                        plugins: {{
                            legend: {{
                                position: 'top'
                            }}
                        }}
                    }}
                }});

                // Component Cost Chart - Minimalistic (Top 4 components only)
                const componentCostCtx = document.getElementById('componentCostChart').getContext('2d');

                // Aggregate component costs across all services
                const componentTotals = {{
                    'Kubernetes Control Plane': 0,
                    'Pod Compute': 0,
                    'CPU': 0,
                    'Memory': 0,
                    'Load Balancer': 0,
                    'Storage': 0,
                    'Network': 0
                }};

                Object.keys(serviceData).forEach(key => {{
                    const service = serviceData[key];
                    if (service.component_costs) {{
                        componentTotals['Kubernetes Control Plane'] += service.component_costs.kubernetes_control_plane || 0;
                        componentTotals['Pod Compute'] += service.component_costs.pod_compute || 0;
                        componentTotals['CPU'] += service.component_costs.cpu || 0;
                        componentTotals['Memory'] += service.component_costs.memory || 0;
                        componentTotals['Load Balancer'] += service.component_costs.load_balancer || 0;
                        componentTotals['Storage'] += service.component_costs.storage || 0;
                        componentTotals['Network'] += service.component_costs.network || 0;
                    }}
                }});

                // Sort and get top 4 components by cost
                const sortedComponents = Object.entries(componentTotals)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 4);

                new Chart(componentCostCtx, {{
                    type: 'bar',
                    data: {{
                        labels: sortedComponents.map(([name]) =>
                            name.length > 15 ? name.substring(0, 12) + '...' : name
                        ),
                        datasets: [{{
                            label: 'Cost per Hour ($)',
                            data: sortedComponents.map(([, cost]) => cost),
                            backgroundColor: [
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(46, 204, 113, 0.8)',
                                'rgba(241, 196, 15, 0.8)',
                                'rgba(155, 89, 182, 0.8)'
                            ],
                            borderColor: [
                                '#3498db', '#2ecc71', '#f1c40f', '#9b59b6'
                            ],
                            borderWidth: 1
                        }}]
                    }},
                    options: {{
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        layout: {{
                            padding: {{
                                left: 5,
                                right: 10,
                                top: 5,
                                bottom: 5
                            }}
                        }},
                        scales: {{
                            x: {{
                                beginAtZero: true,
                                title: {{
                                    display: true,
                                    text: '$/hr',
                                    font: {{
                                        size: 11
                                    }}
                                }},
                                ticks: {{
                                    font: {{
                                        size: 10
                                    }}
                                }}
                            }},
                            y: {{
                                ticks: {{
                                    font: {{
                                        size: 11
                                    }}
                                }}
                            }}
                        }},
                        plugins: {{
                            legend: {{
                                display: false
                            }},
                            tooltip: {{
                                callbacks: {{
                                    label: function(context) {{
                                        const fullName = sortedComponents[context.dataIndex][0];
                                        return fullName + ': $' + context.parsed.x.toFixed(3) + '/hr';
                                    }}
                                }}
                            }}
                        }}
                    }}
                }});

                // Service Cost Chart
                const costCtx = document.getElementById('costChart').getContext('2d');
                new Chart(costCtx, {{
                    type: 'doughnut',
                    data: {{
                        labels: Object.keys(serviceData).map(key => serviceData[key].service_name),
                        datasets: [{{
                            data: Object.keys(serviceData).map(key => serviceData[key].cost_per_hour * 24 * 30),
                            backgroundColor: [
                                '#3498db', '#e74c3c', '#f39c12', '#27ae60',
                                '#9b59b6', '#1abc9c', '#34495e', '#e67e22',
                                '#95a5a6', '#d35400', '#c0392b', '#16a085'
                            ]
                        }}]
                    }},
                    options: {{
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {{
                            legend: {{ position: 'right' }},
                            tooltip: {{
                                callbacks: {{
                                    label: function(context) {{
                                        const value = context.parsed;
                                        return context.label + ': $' + value.toFixed(2) + '/month';
                                    }}
                                }}
                            }}
                        }}
                    }}
                }});

                function refreshData() {{
                    location.reload();
                }}

                // Auto-refresh every 30 seconds
                setInterval(refreshData, 30000);
            </script>
        </body>
        </html>'''
        return html

    @app.route('/api/dashboard')
    def api_dashboard():
        """API endpoint for dashboard data"""
        derived_metrics = calculate_derived_metrics()
        return jsonify({
            'timestamp': datetime.now().isoformat(),
            'namespace': namespace,
            'service_metrics': service_metrics,
            'derived_metrics': derived_metrics,
            'performance_summary': {
                'total_services': len(service_metrics),
                'healthy_services': len([m for m in service_metrics.values() if m['status'] == 'healthy']),
                'total_requests': derived_metrics['total_requests'],
                'error_rate': derived_metrics['overall_error_rate'],
                'avg_response_time': derived_metrics['avg_response_time']
            }
        })

    @app.route('/api/service/<service_name>')
    def api_service_details(service_name):
        """API endpoint for specific service details"""
        service_data = service_metrics.get(service_name, {})
        if not service_data:
            return jsonify({'error': 'Service not found'}), 404

        return jsonify({
            'service_name': service_name,
            'current_metrics': service_data,
            'namespace': namespace,
            'timestamp': datetime.now().isoformat()
        })

    @app.route('/api/costs')
    def api_costs():
        """API endpoint for cost metrics"""
        derived_metrics = calculate_derived_metrics()

        service_costs = []
        for pod_name, metrics in service_metrics.items():
            service_costs.append({
                'service_name': metrics['service_name'],
                'hourly_cost': metrics['cost_per_hour'],
                'daily_cost': metrics['cost_per_hour'] * 24,
                'monthly_cost': metrics['cost_per_hour'] * 24 * 30,
                'request_count': metrics['request_count'],
                'cost_per_request': metrics['cost_per_hour'] / metrics['request_count'] if metrics['request_count'] > 0 else 0
            })

        return jsonify({
            'service_costs': service_costs,
            'total_cluster_cost': {
                'hourly_cost': derived_metrics['total_cost_per_hour'],
                'daily_cost': derived_metrics['total_cost_per_day'],
                'monthly_cost': derived_metrics['total_cost_per_month']
            },
            'namespace': namespace,
            'timestamp': datetime.now().isoformat()
        })

    @app.route('/api/health')
    def api_health():
        """Health check endpoint"""
        return jsonify({
            'status': 'healthy',
            'monitoring_active': True,
            'namespace': namespace,
            'timestamp': datetime.now().isoformat(),
            'version': '2.0.0',
            'services_monitored': len(service_metrics)
        })

    if __name__ == '__main__':
        port = int(os.environ.get('PORT', 5000))
        print(f"Starting Z-Grid Enhanced Monitoring Dashboard on port {port}")
        print(f"Monitoring namespace: {namespace}")
        app.run(host='0.0.0.0', port=port, debug=False)

  requirements.txt: |
    Flask==2.3.3

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fixed-monitoring-dashboard
  namespace: z-grid
  labels:
    app: fixed-monitoring-dashboard
    component: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fixed-monitoring-dashboard
  template:
    metadata:
      labels:
        app: fixed-monitoring-dashboard
        component: monitoring
    spec:
      containers:
      - name: monitoring-dashboard
        image: python:3.11-slim
        command: ['sh', '-c']
        args:
        - |
          cd /app
          pip install --no-cache-dir -r requirements.txt
          python app.py
        ports:
        - containerPort: 5000
          name: http
        env:
        - name: NAMESPACE
          value: "z-grid"
        - name: PORT
          value: "5000"
        - name: PYTHONUNBUFFERED
          value: "1"
        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /api/health
            port: 5000
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /api/health
            port: 5000
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        volumeMounts:
        - name: dashboard-config
          mountPath: /app
          readOnly: false
      volumes:
      - name: dashboard-config
        configMap:
          name: fixed-dashboard-config
      restartPolicy: Always

---
apiVersion: v1
kind: Service
metadata:
  name: z-grid-monitoring-dashboard-service
  namespace: z-grid
  labels:
    app: z-grid-monitoring-dashboard
    component: monitoring
spec:
  selector:
    app: fixed-monitoring-dashboard
  ports:
  - name: http
    port: 5000
    targetPort: 5000
    protocol: TCP
  type: ClusterIP