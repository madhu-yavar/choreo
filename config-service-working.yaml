apiVersion: apps/v1
kind: Deployment
metadata:
  name: config-service-working
  namespace: z-grid
  labels:
    app: config-service-working
spec:
  replicas: 1
  selector:
    matchLabels:
      app: config-service-working
  template:
    metadata:
      labels:
        app: config-service-working
    spec:
      containers:
      - name: config-service-working
        image: python:3.11-slim
        command:
        - /bin/bash
        - -c
        - |
          pip install flask requests
          python3 -c "
          from flask import Flask, request, jsonify
          from datetime import datetime
          import json
          import os

          app = Flask(__name__)

          CONFIG_API_KEYS = ['config123', 'supersecret123', 'biasyavar', 'enhancedconfig123']

          def validate_api_key():
              api_key = request.headers.get('X-API-Key')
              return api_key in CONFIG_API_KEYS

          @app.route('/health', methods=['GET'])
          def health():
              return jsonify({
                  'ok': True,
                  'service': 'Configuration Service',
                  'status': 'running',
                  'timestamp': datetime.now().isoformat()
              })

          @app.route('/config/get', methods=['GET'])
          def get_config():
              if not validate_api_key():
                  return jsonify({'error': 'Invalid API key'}), 401

              config_key = request.args.get('key')
              configs = {
                  'bias_threshold': '0.7',
                  'toxicity_threshold': '0.5',
                  'pii_detection_enabled': 'true',
                  'auto_ban_enabled': 'false',
                  'gateway_timeout': '10',
                  'retry_count': '3'
              }

              if config_key:
                  return jsonify({
                      'key': config_key,
                      'value': configs.get(config_key, 'not_found'),
                      'timestamp': datetime.now().isoformat()
                  })
              else:
                  return jsonify({
                      'configs': configs,
                      'timestamp': datetime.now().isoformat()
                  })

          @app.route('/config/set', methods=['POST'])
          def set_config():
              if not validate_api_key():
                  return jsonify({'error': 'Invalid API key'}), 401

              data = request.get_json()
              if not data or 'key' not in data or 'value' not in data:
                  return jsonify({'error': 'Key and value are required'}), 400

              return jsonify({
                  'key': data['key'],
                  'value': data['value'],
                  'updated': True,
                  'timestamp': datetime.now().isoformat()
              })

          if __name__ == '__main__':
              print(\"ðŸš€ Config Service Starting...\")
              app.run(host='0.0.0.0', port=8002, debug=False)
          "
        ports:
        - containerPort: 8002
        env:
        - name: CONFIG_API_KEYS
          value: "config123,supersecret123,biasyavar,enhancedconfig123"
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        livenessProbe:
          httpGet:
            path: /health
            port: 8002
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8002
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: config-service-working
  namespace: z-grid
spec:
  selector:
    app: config-service-working
  ports:
  - port: 8002
    targetPort: 8002
  type: LoadBalancer