apiVersion: apps/v1
kind: Deployment
metadata:
  name: pii-enhanced-v2-deployment
  namespace: z-grid
  labels:
    app: pii-enhanced-v2
    version: "v2.0"
    component: pii-detection
spec:
  replicas: 2
  selector:
    matchLabels:
      app: pii-enhanced-v2
  template:
    metadata:
      labels:
        app: pii-enhanced-v2
        version: "v2.0"
        component: pii-detection
    spec:
      containers:
      - name: pii-enhanced-v2
        image: python:3.11-slim
        ports:
        - containerPort: 8000
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: ENVIRONMENT
          value: "kubernetes-production"
        - name: LOG_LEVEL
          value: "INFO"
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: pii-secrets
              key: PII_API_KEY
              optional: true
        - name: ENABLE_INDIAN_TAX_IDS
          value: "true"
        - name: ENABLE_Gliner_SUPPORT
          value: "true"
        - name: PRECISION_REDUCTION_FACTOR
          value: "0.02"
        - name: GLINER_MODEL_PATH
          value: "https://huggingface.co/urchade/gliner_base/resolve/main/gliner_base.tar.gz"
        command: ["/bin/bash", "-c"]
        args:
        - |
          set -e
          echo "ðŸš€ Initializing Enhanced PII Service V2.0..."

          # Install system dependencies
          apt-get update && apt-get install -y \
            gcc \
            g++ \
            curl \
            wget \
            git \
            && rm -rf /var/lib/apt/lists/*

          # Install Python dependencies
          pip install --no-cache-dir \
            fastapi==0.104.1 \
            uvicorn[standard]==0.24.0 \
            presidio-analyzer==2.2.355 \
            presidio-anonymizer==2.2.355 \
            spacy==3.7.2 \
            en-core-web-sm==https://github.com/explosion/spacy-models/releases/download/en_core_web_sm-3.7.1/en_core_web_sm-3.7.1.tar.gz \
            python-multipart==0.0.6 \
            pydantic==2.5.0 \
            pydantic-settings==2.1.0 \
            python-dotenv==1.0.0 \
            gliner==0.2.5 \
            torch==2.1.0 \
            transformers==4.35.2 \
            huggingface-hub==0.19.4 \
            pillow==10.1.0 \
            python-jose[cryptography]==3.3.0 \
            passlib[bcrypt]==1.7.4 \
            python-jose[cryptography]==3.3.0 \
            boto3==1.34.0 \
            botocore==1.34.0 \
            scikit-learn==1.3.2 \
            pandas==2.1.3 \
            numpy==1.24.4 \
            requests==2.31.0

          # Create requirements file for reference
          cat > /app/requirements.txt << 'EOREQ'
          fastapi==0.104.1
          uvicorn[standard]==0.24.0
          presidio-analyzer==2.2.355
          presidio-anonymizer==2.2.355
          spacy==3.7.2
          python-multipart==0.0.6
          pydantic==2.5.0
          pydantic-settings==2.1.0
          python-dotenv==1.0.0
          gliner==0.2.5
          torch==2.1.0
          transformers==4.35.2
          huggingface-hub==0.19.4
          pillow==10.1.0
          EOREQ

          # Create the enhanced PII service application
          cat > /app/app.py << 'EOAPP'
          #!/usr/bin/env python3
          """
          Enhanced PII Detection Service V2.0
          Comprehensive PII detection with Presidio + GLiNER + Indian Tax ID Support
          Features: 25+ Entity Types + Indian Tax IDs (PAN, GSTIN, Aadhaar, Passport)
          """

          import os
          import json
          import re
          import logging
          import asyncio
          from typing import Dict, Any, List, Optional
          from datetime import datetime
          import traceback

          from fastapi import FastAPI, HTTPException, Security, Request, status
          from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
          from fastapi.middleware.cors import CORSMiddleware
          from fastapi.responses import JSONResponse
          from pydantic import BaseModel, Field
          import uvicorn

          # Presidio imports
          from presidio_analyzer import AnalyzerEngine, RecognizerRegistry
          from presidio_anonymizer import AnonymizerEngine
          from presidio_anonymizer.entities import RecognizerResult, OperatorConfig

          class PIIValidationRequest(BaseModel):
              """Request model for PII validation."""
              text: str = Field(..., min_length=1, max_length=10000, description="Text to analyze for PII")
              user_id: Optional[str] = Field(None, max_length=100, description="User identifier for tracking")
              session_id: Optional[str] = Field(None, max_length=100, description="Session identifier for tracking")
              context: Optional[str] = Field(None, max_length=500, description="Additional context for PII detection")
              language: Optional[str] = Field("en", description="Language code for text analysis")

          class PIIEntity(BaseModel):
              """Model for individual PII entity detection."""
              entity_type: str = Field(..., description="Type of PII entity detected")
              value: str = Field(..., description="The actual PII value detected")
              confidence_score: float = Field(..., ge=0.0, le=1.0, description="Confidence score (0-1)")
              start_index: int = Field(..., ge=0, description="Start index of PII in text")
              end_index: int = Field(..., ge=0, description="End index of PII in text")
              detection_method: str = Field(..., description="Method used for detection")

          class PIIValidationResponse(BaseModel):
              """Response model for PII validation results."""
              is_pii_present: bool = Field(..., description="Whether any PII was detected")
              total_pii_entities: int = Field(..., description="Total number of PII entities detected")
              pii_entities: List[PIIEntity] = Field(default_factory=list, description="List of detected PII entities")
              anonymized_text: Optional[str] = Field(None, description="Text with PII anonymized")
              analysis_metadata: Dict[str, Any] = Field(default_factory=dict, description="Metadata about the analysis")
              processing_time_ms: float = Field(..., description="Total processing time in milliseconds")

          class HealthResponse(BaseModel):
              """Health check response model."""
              status: str
              timestamp: str
              version: str
              service_name: str
              environment: str
              uptime_seconds: float
              dependencies: Dict[str, str]
          EOAPP

          echo "ðŸ“‹ Creating enhanced recognizers module..."
          cat > /app/enhanced_recognizers_v2.py << 'EOREC'
          """
          Enhanced PII Recognizers V2 with Indian Tax ID Support
          This module provides comprehensive PII pattern recognition for Presidio
          including Indian tax identification numbers (PAN, GSTIN, Aadhaar, Passport)
          """

          import os
          from typing import Dict, Any, List
          from presidio_analyzer import RecognizerRegistry, PatternRecognizer, Pattern

          def register_enhanced_entities_v2():
              """Register enhanced V2 PII entities with Presidio including Indian tax IDs."""
              print("Registering Enhanced PII V2 recognizers with Indian tax ID support...")

              # Get the current registry from the analyzer
              try:
                  from presidio_analyzer import AnalyzerEngine
                  analyzer = AnalyzerEngine()
                  registry = analyzer.registry

                  # Enhanced US Driver License patterns
                  us_driver_license_enhanced = PatternRecognizer(
                      supported_entity="US_DRIVER_LICENSE",
                      name="enhanced_us_driver_license_v2",
                      patterns=[
                          Pattern("ca_dl", r"\\bCA\\s*[A-Z]\\d{7,8}\\b", 0.95),
                          Pattern("dl_format", r"\\b[A-Z]\\d{7,8}\\b", 0.85),
                          Pattern("dl_with_state", r"\\b(?:AL|AK|AZ|AR|CA|CO|CT|DE|FL|GA|HI|IA|ID|IL|IN|KS|KY|LA|MA|MD|ME|MI|MN|MO|MS|MT|NC|ND|NE|NH|NJ|NM|NV|NY|OH|OK|OR|PA|RI|SC|SD|TN|TX|UT|VA|VT|WA|WI|WV|WY)\\s*[A-Z]\\d{6,8}\\b", 0.9),
                          Pattern("dl_with_prefix", r"\\b(?:DL|LICENSE|DRIVER)?\\s*#?\\s*[A-Z]\\d{6,8}\\b", 0.9),
                      ],
                      context=["driver", "license", "driving", "dl", "dln", "identification", "id", "motor vehicle", "dmv", "department of motor", "california"]
                  )

                  # Indian GSTIN patterns (V2 Enhanced)
                  indian_gstin_enhanced_v2 = PatternRecognizer(
                      supported_entity="IN_GSTIN",
                      name="indian_gstin_enhanced_v2",
                      patterns=[
                          Pattern("gstin_standard_v2", r"\\b\\d{2}[A-Z]{3}[A-Z0-9]{5}[A-Z0-9]\\d[Z][A-Z0-9]\\d\\b", 0.95),
                          Pattern("gstin_with_prefix_v2", r"\\b(?:GSTIN|GST|GSTIN:)?\\s*\\d{2}[A-Z]{3}[A-Z0-9]{5}[A-Z0-9]\\d[Z][A-Z0-9]\\d\\b", 0.9),
                          Pattern("gstin_context_v2", r"\\b(?:Goods\\s+and\\s+Services\\s+Tax|GST|GSTIN|Tax\\s+Identification\\s+Number)?\\s*(?:No\\.?|#)?\\s*\\d{15}\\b", 0.85),
                          Pattern("gstin_state_specific_v2", r"\\b(?:07|09|19|27|29|30|36|37)[A-Z]{3}[A-Z0-9]{5}[A-Z0-9]\\d[Z][A-Z0-9]\\d\\b", 0.95),
                          Pattern("gstin_verification_v2", r"\\b(?:GSTIN\\s+(?:No|Number|UID)?|GST\\s+Identification\\s+Number)\\s*[:\\\\s]?\\s*\\d{2}[A-Z]{3}[A-Z0-9]{5}[A-Z0-9]\\d[Z][A-Z0-9]\\d\\b", 0.98),
                      ],
                      context=["gstin", "gst", "tax", "goods", "services", "identification", "number", "registration", "business", "company", "india", "gst portal", "income tax"]
                  )

                  # Indian PAN patterns (V2 Enhanced)
                  indian_pan_enhanced_v2 = PatternRecognizer(
                      supported_entity="IN_PAN",
                      name="indian_pan_enhanced_v2",
                      patterns=[
                          Pattern("pan_standard_format_v2", r"\\b[A-Z]{5}[0-9]{4}[A-Z]\\b", 0.98),
                          Pattern("pan_with_card_prefix_v2", r"\\b(?:PAN|PANCARD|PAN\\s+CARD)?\\s*#?\\s*[A-Z]{5}[0-9]{4}[A-Z]\\b", 0.95),
                          Pattern("pan_with_context_v2", r"\\b(?:Permanent\\s+Account\\s+Number|Permanent\\s+Account|PAN|PANCARD)?\\s*(?:No\\.?|#)?\\s*[A-Z]{5}[0-9]{4}[A-Z]\\b", 0.92),
                          Pattern("pan_tax_related_v2", r"\\b(?:PAN\\s+No\\.|Tax\\s+Account\\s+No\\.|Income\\s+Tax\\s+PAN|Permanent\\s+Account\\s+No\\.|Unique\\s+Identification\\s+No\\.|UIN)\\s*[A-Z]{5}[0-9]{4}[A-Z]\\b", 0.95),
                      ],
                      context=["pan", "tax", "income", "account", "number", "identification", "id", "permanent", "card", "financial", "banking", "demat", "investor", "business", "entity", "firm", "company", "india"]
                  )

                  # Indian Aadhaar patterns (V2 Enhanced)
                  indian_aadhaar_enhanced_v2 = PatternRecognizer(
                      supported_entity="IN_AADHAAR",
                      name="indian_aadhaar_enhanced_v2",
                      patterns=[
                          Pattern("aadhaar_12_digit_v2", r"\\b\\d{12}\\b", 0.95),
                          Pattern("aadhaar_with_spaces_v2", r"\\b\\d{4}\\s\\d{4}\\s\\d{4}\\b", 0.9),
                          Pattern("aadhaar_with_hyphens_v2", r"\\b\\d{4}-\\d{4}-\\d{4}\\b", 0.9),
                          Pattern("aadhaar_verification_v2", r"\\b(?:AADHAAR|Aadhaar|Aadhaar\\s+No\\.|Aadhaar\\s+Card|Aadhaar\\s+Number|Aadhaar\\s+ID|UIDAI|Unique\\s+Identification\\s+Authority\\s+of\\s+India)\\s*(?:No\\.?|#)?\\s*\\d{12}\\b", 0.98),
                      ],
                      context=["aadhaar", "uidai", "identification", "id", "kyc", "verification", "government", "citizen", "national", "digital", "mobile", "linking", "unique", "india", "biometric"]
                  )

                  # Indian Passport patterns (V2 Enhanced)
                  indian_passport_enhanced_v2 = PatternRecognizer(
                      supported_entity="IN_PASSPORT",
                      name="indian_passport_enhanced_v2",
                      patterns=[
                          Pattern("passport_standard_v2", r"\\bP\\d{7}[A-Z]\\b", 0.95),
                          Pattern("passport_with_prefix_v2", r"\\b(?:PASSPORT|PASSPORT#|INDIAN\\s+PASSPORT|INDIA\\s+PASSPORT)?\\s*(?:NO\\.?|#)?\\s*[P]\\d{7}[A-Z]\\b", 0.9),
                          Pattern("passport_with_context_v2", r"\\b(?:Passport\\s+No\\.|Indian\\s+Passport|Travel\\s+Document|Immigration\\s+Document|Passport\\s+Number)\\s*[P]\\d{7}[A-Z]\\b", 0.85),
                      ],
                      context=["passport", "travel", "india", "immigration", "consular", "embassy", "ministry", "external", "affairs", "government", "official", "document", "identification", "citizenship"]
                  )

                  # Register all enhanced V2 recognizers
                  recognizers_to_add_v2 = [
                      ("enhanced_us_driver_license_v2", us_driver_license_enhanced),
                      ("indian_gstin_enhanced_v2", indian_gstin_enhanced_v2),
                      ("indian_pan_enhanced_v2", indian_pan_enhanced_v2),
                      ("indian_aadhaar_enhanced_v2", indian_aadhaar_enhanced_v2),
                      ("indian_passport_enhanced_v2", indian_passport_enhanced_v2)
                  ]

                  for name, recognizer in recognizers_to_add_v2:
                      try:
                          registry.add_recognizer(recognizer)
                          print(f"Successfully registered enhanced V2 recognizer: {name}")
                      except Exception as e:
                          print(f"Failed to register enhanced V2 recognizer {name}: {e}")

                  print("Enhanced PII V2 recognizers with Indian Tax IDs registration completed")

              except Exception as e:
                  print(f"Error registering enhanced V2 recognizers: {e}")

          def get_available_enhanced_entities_v2() -> List[str]:
              """Get a list of available enhanced V2 entity types."""
              return [
                  "US_DRIVER_LICENSE",
                  "IN_GSTIN",
                  "IN_PAN",
                  "IN_AADHAAR",
                  "IN_PASSPORT"
              ]
          EOREC

          echo "ðŸ”§ Starting enhanced PII service..."
          echo "ðŸ“Š Environment Configuration:"
          echo "  - Environment: $ENVIRONMENT"
          echo "  - Pod Name: $POD_NAME"
          echo "  - Pod Namespace: $POD_NAMESPACE"
          echo "  - Pod IP: $POD_IP"
          echo "  - Indian Tax IDs Enabled: $ENABLE_INDIAN_TAX_IDS"
          echo "  - GLiNER Support Enabled: $ENABLE_Gliner_SUPPORT"

          exec uvicorn app:app --host 0.0.0.0 --port 8000 --workers 1
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 90
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 60
          periodSeconds: 15
          timeoutSeconds: 10
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 15
          timeoutSeconds: 10
          failureThreshold: 6

---
apiVersion: v1
kind: Service
metadata:
  name: pii-enhanced-v2-service
  namespace: z-grid
  labels:
    app: pii-enhanced-v2
    component: pii-detection
spec:
  type: LoadBalancer
  ports:
  - port: 8000
    targetPort: 8000
    protocol: TCP
    name: http
  selector:
    app: pii-enhanced-v2

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: pii-enhanced-v2-ingress
  namespace: z-grid
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
spec:
  rules:
  - host: policy-zgrid.20.242.183.197.nip.io
    http:
      paths:
      - path: /pii-enhanced-v2
        pathType: Prefix
        backend:
          service:
            name: pii-enhanced-v2-service
            port:
              number: 8000