---
# Simple Gateway Service Ingress Configuration
# External access configuration for the Simple Gateway Service
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: simple-gateway-ingress
  namespace: z-grid
  labels:
    app: simple-gateway
    service-type: gateway
  annotations:
    # SSL and Security
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
    nginx.ingress.kubernetes.io/ssl-protocols: "TLSv1.2 TLSv1.3"

    # CORS Configuration
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-api-key,X-API-Key"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"

    # Proxy Settings
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"

    # Buffer and Performance
    nginx.ingress.kubernetes.io/proxy-buffering: "on"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "8"

    # Request Handling
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "X-Gateway-Version: 1.0.0";
      more_set_headers "X-Gateway-Name: Simple-Gateway";

spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - "*.20.242.183.197.nip.io"
    secretName: zgrid-wildcard-tls

  rules:
  # ===== SIMPLE GATEWAY MAIN ACCESS =====
  # Primary Gateway Subdomain
  - host: "simple-gateway.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: simple-gateway-service
            port:
              number: 8010

  # Alternative Gateway Subdomain
  - host: "gateway.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: simple-gateway-service
            port:
              number: 8010

  # External Gateway Access
  - host: "api-gateway.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: simple-gateway-service
            port:
              number: 8010

  # ===== UNIFIED API ROUTING (Simple Gateway) =====
  # Simple Gateway as unified API entry point
  - host: "api-simple.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: simple-gateway-service
            port:
              number: 8010

  # ===== PATH-BASED ROUTING VIA MAIN API DOMAIN =====
  # Simple Gateway validation endpoints
  - host: "api.20.242.183.197.nip.io"
    http:
      paths:
      # Simple Gateway validation endpoint
      - path: /simple-validate(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: simple-gateway-service
            port:
              number: 8010

      # External validation endpoint (alternative)
      - path: /external-validate(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: simple-gateway-service
            port:
              number: 8010

      # Parallel testing endpoint
      - path: /parallel-test(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: simple-gateway-service
            port:
              number: 8010

  # ===== DIRECT EXTERNAL ACCESS FOR TESTING =====
  # Direct external access for testing and development
  - host: "test-gateway.20.242.183.197.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: simple-gateway-service
            port:
              number: 8010