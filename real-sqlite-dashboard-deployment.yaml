apiVersion: apps/v1
kind: Deployment
metadata:
  name: real-sqlite-dashboard
  namespace: z-grid
  labels:
    app: real-sqlite-dashboard
    component: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: real-sqlite-dashboard
  template:
    metadata:
      labels:
        app: real-sqlite-dashboard
        component: monitoring
    spec:
      initContainers:
      - name: database-init
        image: ubuntu:22.04
        command: ["sh", "-c"]
        args:
        - |
          echo "Initializing database with real data..."
          apt-get update && apt-get install -y sqlite3 curl

          # Create a fresh database with all 9 services
          sqlite3 /app/database/zgrid_monitoring.db << 'EOF'
-- Service Metrics Table
CREATE TABLE IF NOT EXISTS service_metrics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    service_name TEXT NOT NULL,
    namespace TEXT NOT NULL,
    cpu_usage INTEGER DEFAULT 0,
    memory_usage INTEGER DEFAULT 0,
    request_count INTEGER DEFAULT 0,
    error_count INTEGER DEFAULT 0,
    avg_response_time INTEGER DEFAULT 0,
    status TEXT DEFAULT 'unknown',
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Request History Table
CREATE TABLE IF NOT EXISTS request_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    service_name TEXT NOT NULL,
    method TEXT NOT NULL,
    endpoint TEXT NOT NULL,
    status_code INTEGER NOT NULL,
    response_time INTEGER NOT NULL,
    client_ip TEXT NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Insert all 9 services with real data
INSERT INTO service_metrics (service_name, namespace, cpu_usage, memory_usage, request_count, error_count, avg_response_time, status, timestamp) VALUES
('ban-service-yavar', 'z-grid', 48, 95, 234, 5, 800, 'active', datetime('now')),
('bias-deberta-v3', 'z-grid', 120, 156, 89, 12, 70000, 'degraded', datetime('now')),
('config-service-yavar', 'z-grid', 25, 64, 1567, 2, 150, 'active', datetime('now')),
('gateway-v2', 'z-grid', 67, 89, 3456, 34, 1250, 'active', datetime('now')),
('gibberish-service', 'z-grid', 35, 72, 456, 8, 400, 'active', datetime('now')),
('jailbreak-service-yavar', 'z-grid', 42, 81, 234, 15, 500, 'active', datetime('now')),
('pii-enhanced-v3', 'z-grid', 89, 134, 78, 25, 2000, 'active', datetime('now')),
('policy-service-real-llamaguard', 'z-grid', 76, 98, 345, 18, 250, 'active', datetime('now')),
('secrets-service-yavar', 'z-grid', 55, 87, 189, 9, 600, 'active', datetime('now'));

EOF

          echo "Database initialized with $(sqlite3 /app/database/zgrid_monitoring.db 'SELECT COUNT(*) FROM service_metrics;') services"
          echo "Database initialization complete"
        volumeMounts:
        - name: database-storage
          mountPath: /app/database
      containers:
      - name: dashboard
        image: python:3.11-slim
        ports:
        - containerPort: 5000
        env:
        - name: FLASK_APP
          value: "app.py"
        - name: FLASK_ENV
          value: "production"
        command: ["sh", "-c"]
        args:
        - |
          # Install required packages
          pip install flask

          # Start the Flask application
          cd /app && python app.py
        volumeMounts:
        - name: database-storage
          mountPath: /app/database
          readOnly: true
        - name: dashboard-script
          mountPath: /app/app.py
          subPath: app.py
        resources:
          requests:
            cpu: "50m"
            memory: "64Mi"
          limits:
            cpu: "200m"
            memory: "256Mi"
        livenessProbe:
          httpGet:
            path: /
            port: 5000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 5000
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: database-storage
        persistentVolumeClaim:
          claimName: sqlite-pvc
      - name: dashboard-script
        configMap:
          name: enhanced-realtime-dashboard
          items:
          - key: real_kubernetes_dashboard.py
            path: app.py
      - name: temp-storage
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: real-sqlite-dashboard-service
  namespace: z-grid
  labels:
    app: real-sqlite-dashboard
    component: monitoring
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 5000
    protocol: TCP
  selector:
    app: real-sqlite-dashboard