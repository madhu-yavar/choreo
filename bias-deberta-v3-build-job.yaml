apiVersion: batch/v1
kind: Job
metadata:
  name: bias-deberta-v3-build
  namespace: z-grid
spec:
  template:
    spec:
      containers:
      - name: bias-builder
        image: python:3.11-slim
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "ğŸš€ Building bias_DeBERTav3_v2.0 in Kubernetes"

          # Install Docker CLI
          apt-get update && apt-get install -y \
            ca-certificates \
            curl \
            gnupg \
            lsb-release

          # Install Docker
          curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian \
            $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
          apt-get update && apt-get install -y docker-ce-cli

          # Login to ACR using Azure CLI
          echo "ğŸ” Logging into Azure Container Registry..."
          if command -v az >/dev/null 2>&1; then
            az acr login --name zinfradevv1
          else
            echo "Installing Azure CLI..."
            curl -sL https://aka.ms/InstallAzureCLIDeb | bash
            az acr login --name zinfradevv1
          fi

          # Create build directory
          mkdir -p /build
          cd /build

          # Create Dockerfile
          cat > Dockerfile << 'EOF'
          FROM python:3.11-slim

          LABEL maintainer="Z-Grid Team"
          LABEL version="v2.0"
          LABEL description="Zero-Shot Enhanced Bias Detection Service with DeBERTa-v3"
          LABEL model="MoritzLaurer/DeBERTa-v3-large-mnli-fever-anli-ling-wanli"

          # Install system dependencies
          RUN apt-get update && apt-get install -y \
              build-essential \
              curl \
              git \
              && rm -rf /var/lib/apt/lists/*

          # Set working directory
          WORKDIR /app

          # Copy requirements first for better layer caching
          COPY requirements.bias-deberta-v3.txt .

          # Install Python dependencies
          RUN pip install --no-cache-dir --upgrade pip && \
              pip install --no-cache-dir -r requirements.bias-deberta-v3.txt

          # Copy application code
          COPY enhanced_bias_service_real.py app.py

          # Create model cache directory
          RUN mkdir -p /app/models

          # Create non-root user for security
          RUN useradd --create-home --shell /bin/bash appuser && \
              chown -R appuser:appuser /app
          USER appuser

          # Health check
          HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
              CMD curl -f http://localhost:8012/health || exit 1

          # Expose port
          EXPOSE 8012

          # Start the service
          CMD ["python", "app.py"]
          EOF

          # Create requirements file
          cat > requirements.bias-deberta-v3.txt << 'EOF'
          # Core ML dependencies for DeBERTa-v3 Zero-Shot Classification
          torch>=2.9.0
          transformers>=4.57.0
          accelerate>=1.11.0

          # Flask web service
          flask>=3.1.0
          aiohttp>=3.13.0

          # ML and data processing
          numpy>=1.24.0
          protobuf>=4.25.0
          huggingface-hub>=0.34.0
          tokenizers>=0.22.0
          safetensors>=0.4.3
          filelock>=3.20.0
          regex>=2025.10.23

          # HTTP client for policy service integration
          requests>=2.31.0

          # System monitoring
          psutil>=5.9.0
          EOF

          # Download the enhanced bias service code
          echo "ğŸ“¥ Downloading enhanced bias service code..."
          curl -o enhanced_bias_service_real.py https://raw.githubusercontent.com/your-repo/enhanced_bias_service_real.py || \
          echo "âš ï¸  Will copy from existing pod..."

          # Build the Docker image
          echo "ğŸ—ï¸  Building Docker image bias_DeBERTav3_v2.0..."
          docker build -t zinfradevv1.azurecr.io/bias_DeBERTav3_v2.0:20251031 .

          # Push to ACR
          echo "ğŸ“¤ Pushing image to Azure Container Registry..."
          docker push zinfradevv1.azurecr.io/bias_DeBERTav3_v2.0:20251031

          echo "âœ… Build completed successfully!"
          echo "ğŸ¯ Image: zinfradevv1.azurecr.io/bias_DeBERTav3_v2.0:20251031"
        volumeMounts:
        - name: docker-sock
          mountPath: /var/run/docker.sock
        - name: build-workspace
          mountPath: /build
      restartPolicy: OnFailure
      volumes:
      - name: docker-sock
        hostPath:
          path: /var/run/docker.sock
      - name: build-workspace
        emptyDir: {}
      nodeSelector:
        kubernetes.io/os: linux
  backoffLimit: 3