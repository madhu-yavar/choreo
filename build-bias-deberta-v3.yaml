apiVersion: v1
kind: Pod
metadata:
  name: kaniko-bias-deberta-build
  namespace: z-grid
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    args:
    - "--dockerfile=Dockerfile.bias-deberta-v3"
    - "--context=dir:///workspace"
    - "--destination=zinfradevv1.azurecr.io/bias_DeBERTav3_v2.0:20251031"
    - "--cache=true"
    - "--cache-repo=zinfradevv1.azurecr.io/kaniko-cache"
    - "--verbosity=debug"
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker
    - name: workspace
      mountPath: /workspace
  restartPolicy: Never
  volumes:
  - name: docker-config
    configMap:
      name: docker-config
  - name: workspace
    emptyDir: {}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: docker-config
  namespace: z-grid
data:
  config.json: |
    {
      "auths": {
        "zinfradevv1.azurecr.io": {
          "username": "zinfradevv1",
          "password": "<AZURE_ACR_PASSWORD>",
          "auth": "<BASE64_AUTH>"
        }
      }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: bias-deberta-build-files
  namespace: z-grid
data:
  Dockerfile.bias-deberta-v3: |
    FROM python:3.11-slim

    LABEL maintainer="Z-Grid Team"
    LABEL version="v2.0"
    LABEL description="Zero-Shot Enhanced Bias Detection Service with DeBERTa-v3"
    LABEL model="MoritzLaurer/DeBERTa-v3-large-mnli-fever-anli-ling-wanli"

    # Install system dependencies
    RUN apt-get update && apt-get install -y \
        build-essential \
        curl \
        git \
        && rm -rf /var/lib/apt/lists/*

    # Set working directory
    WORKDIR /app

    # Copy requirements first for better layer caching
    COPY requirements.bias-deberta-v3.txt .

    # Install Python dependencies
    RUN pip install --no-cache-dir --upgrade pip && \
        pip install --no-cache-dir -r requirements.bias-deberta-v3.txt

    # Copy application code
    COPY enhanced_bias_service_real.py app.py

    # Create model cache directory
    RUN mkdir -p /app/models

    # Create non-root user for security
    RUN useradd --create-home --shell /bin/bash appuser && \
        chown -R appuser:appuser /app
    USER appuser

    # Health check
    HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
        CMD curl -f http://localhost:8012/health || exit 1

    # Expose port
    EXPOSE 8012

    # Start the service
    CMD ["python", "app.py"]

  requirements.bias-deberta-v3.txt: |
    # Core ML dependencies for DeBERTa-v3 Zero-Shot Classification
    torch>=2.9.0
    transformers>=4.57.0
    accelerate>=1.11.0

    # Flask web service
    flask>=3.1.0
    aiohttp>=3.13.0

    # ML and data processing
    numpy>=1.24.0
    protobuf>=4.25.0
    huggingface-hub>=0.34.0
    tokenizers>=0.22.0
    safetensors>=0.4.3
    filelock>=3.20.0
    regex>=2025.10.23

    # HTTP client for policy service integration
    requests>=2.31.0

    # System monitoring
    psutil>=5.9.0